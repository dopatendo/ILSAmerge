---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```



# ILSAmerge <img src="man/figures/logo.png" align="right" height="127" alt="" />

It is common that data from International Large-Scale Assessments (ILSA), 
like TIMSS, TIMSS Advanced, PIRLS, ICCS, ICILS, CIVED, REDS, RLII, and SITES,
come in an unaggregated format. 

That means that data is published in hundreds of files, each of one represents
a combination of countries and participants (students, teachers, principals,
etc.)

It is also common that researches would need to merge this data to include
all countries into a single file. 

The goal of ILSAmerge is to make this process as simple and as straightforward
as possible.


<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/ILSAmerge)](https://CRAN.R-project.org/package=ILSAmerge)
![GitHub R package version](https://img.shields.io/github/r-package/v/dopatendo/ILSAmerge)
[![](https://img.shields.io/badge/lifecycle-stable-brightgreen.svg)](https://lifecycle.r-lib.org/articles/stages.html#stable)
![Static Badge](https://img.shields.io/badge/dependencies-haven-brightgreen)
[![](https://img.shields.io/badge/doi-10.32614/CRAN.package.ILSAmerge-green.svg)](https://doi.org/10.32614/CRAN.package.ILSAmerge)
<!-- ![![](http://cranlogs.r-pkg.org/badges/grand-total/ILSAmerge?color=blue)](https://cran.r-project.org/package=ILSAmerge)-->
<!-- badges: end -->

## Installation

You can install the stable version of `ILSAmerge` directly from CRAN:

```{r, eval = FALSE}
install.packages("ILSAmerge")
```


Or, if you wish to install the development version of `ILSAmerge`:

```{r, eval = FALSE}
remotes::install_github("dopatendo/ILSAmerge")
```

```{r, echo = FALSE}
library(ILSAmerge)

```

## Downloading files - `ILSAdownload()`
We can download SPSS files of supported ILSA using `ILSAdownload()`. If we do,
a license agreement will be downloaded, and the user will be prompted to agree
with these terms, otherwise data will not be downloaded. We can also decide if
we want to unzip them:


```{r}
output <- tempdir()
ILSAdownload(study = "RLII", year = 1991, outputdir = output, unzip = TRUE,agreeLicense = TRUE)


```





## Identifying files - `ILSAfiles.info()`

For example, if we download the data of RLII 1991 from its original source,
we could find the SPSS data files in a path like this:


```{r, eval = TRUE}

input <- file.path(output,"RLII1991_IDB_SPSS/Data")
```


Where we could a large number of files:
```{r}
length(list.files(input))
list.files(input)
```

To summarize this information, we can use  `ILSAfile.info()`:
```{r}

ILSAfile.info(inputdir = input)
```

Where we can see how many file types or populations exist in the path, how many
files per population, and the combined storage of all these file.


## Merging files - `ILSAmerge()`

Using the same path we can automatically convert these 130 files into just 5,
one for each population.

For that we only need to include a new path, where the merged files will be 
saved:

```{r}
dir.create(file.path(tempdir(),"RLII1991_IDB_SPSS/MERGED"),showWarnings = FALSE)
output <- file.path(tempdir(),"RLII1991_IDB_SPSS/MERGED")
```


Then, we can simply run `ILSAmerge()` and all files will be merged. The default
type will be an "rds", but also we can make "zsav" and "sav" files:

```{r, eval=FALSE}
ILSAmerge(inputdir = input, outputdir = output, filetype = c("rds", "zsav", "sav"))
```


## Adjusting merge options

Depending on your goals or the capabilities of your computer, 
you may consider adjusting some options of `ILSAmerge()`:

- `population`: If you need to merge only some of the populations from the
path, you could include them here as a character vector. It should be in the 
same format as the output of `ILSAfile.info`.
- `MBlimit`: If set to `NULL`, the default, all files will be
merged within R. If set a numeric value that will establish a limit (from the
output of `ILSAfile.info`) of which files are going to be merged by R, 
the populations that go over this limit will not be merged by R, but instead an
SPSS syntax will be produced. Later, you can use this syntax to merge the files.
- `MBlistlimit`: In `ILSAmerge()` files are merged in two ways: using a list
produced by an lapply function, or an empty matrix filled up by subscripts.
The first method is almost always faster, but it can use a lot of memory.
This argument establishes a limit for merging by list and not by matrix.
We recommend not setting this higher than 200.
- `SPSSlimit`: If SPSS syntaxes are going to be produced it is important to
take into account the SPSS requirements for handling files. This could vary
by SPSS version, but normally it is a total of 50 files per command.

## Progress and time for merging

When `ILSAmerge()` runs, information about the progress of the merging and the
running time will be produced:

```{r, eval=TRUE}
ILSAmerge(inputdir = input, outputdir = output, filetype = c("rds", "zsav", "sav"))
```

## Loading data without merging

If we need to load the data but not save it, we can use `justload()`. By 
default, it will load all datasets of an specific population:
```{r}
list <- justload(inputdir = input, population = "ASCt1")
class(list)
sapply(list,dim)
```

Nevertheless, it is also possible to load all the datasets of a single 
population without rows, i.e., just the attributes of the columns. This could be
helpful for running some consistency checks between files:
```{r}
list <- justload(inputdir = input, population = "ASCt1", justattributes = TRUE)
class(list)
sapply(list,dim)

list[[1]]
```

